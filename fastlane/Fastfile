default_platform(:ios)
# disable analytics messages
skip_docs
opt_out_usage
allow_fallback_to_no_signing true

platform :ios do
  desc "CI lane: import certs/profiles from env, build and export .ipa"
  lane :ci do
    require 'base64'
    scheme = ENV['XCODE_SCHEME'] || 'SailTact'
    workspace = ENV['XCODE_WORKSPACE']
    project = ENV['XCODE_PROJECT']
    export_method = ENV['EXPORT_METHOD'] || 'development'
    output_dir = 'out'

    sh("mkdir -p #{output_dir}")

    options = {
      scheme: scheme,
      export_method: export_method,
      output_directory: output_dir,
      output_name: scheme
    }
    options[:workspace] = workspace if workspace && workspace.length > 0
    options[:project] = project if project && project.length > 0
    # Look for ExportOptions.plist in repo root or fastlane dir
    if File.exist?('../ExportOptions.plist')
      options[:export_options] = '../ExportOptions.plist'
    elsif File.exist?('ExportOptions.plist')
      options[:export_options] = 'ExportOptions.plist'
    end
    UI.message("Using options: #{options.inspect}")

    build_app(options)

    UI.message("Build complete. IPA should be in #{output_dir}")
  end
end
